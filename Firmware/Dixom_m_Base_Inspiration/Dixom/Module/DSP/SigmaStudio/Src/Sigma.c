#include <Sigma.h>
#include <Structures.h>
#include "DIXOM_DAC_ADAU1962_REG.h"
#include "DIXOM_DAC_ADAU1962.h"
#include "Base_DSP_ADAU1452_REG.h"
#include "Base_DSP_ADAU1452.h"
#include "Base_DSP_ADAU1452_PARAM.h"
#include "ADAU1701_IC_1_PARAM.h"
#include "ADAU1701_IC_1_REG.h"
#include "ADAU1701_IC_1.h"
#include "Exchange.h"
#include "DSP_Exchange.h"
#include "AudioDAC.h"
#include "DSP.h"
#include <Structures.h>

extern sDixom Dixom;

void Initialization_DSP_Audio_Processor(void){

	SPI_mode_DSP(); //Putting the DSP in SPI mode
	Delay(30, FreeRTOS);

	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOFT_RESET_DSP_ADAU1452_ADDR, REG_SOFT_RESET_DSP_ADAU1452_BYTE, &R0_SOFT_RESET_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOFT_RESET_DSP_ADAU1452_ADDR, REG_SOFT_RESET_DSP_ADAU1452_BYTE, &R1_SOFT_RESET_DSP_ADAU1452_Default[0] );


	DSP_Clock();
	Delay(30, FreeRTOS);
	uint8_t    result[2];
	short regStatus = 0;

    for( short StatusPll=0; StatusPll<10; StatusPll++ ){

    	Receiver_DSP(61444,  &result[0], 2, 500);
		if( result[0] != 0 || result[1] != 1 || regStatus == 1 ){

			Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_PLL_ENABLE_DSP_ADAU1452_ADDR,  2, &R8_PLL_ENABLE_DSP_ADAU1452_Default[0] );
			Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_PLL_CTRL0_DSP_ADAU1452_ADDR,   2, &R9_PLL_CTRL0_DSP_ADAU1452_Default[0] );
		    Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_PLL_CTRL1_DSP_ADAU1452_ADDR,   2, &R10_PLL_CTRL1_DSP_ADAU1452_Default[0] );
		    Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_PLL_CLK_SRC_DSP_ADAU1452_ADDR, 2, &R11_PLL_CLK_SRC_DSP_ADAU1452_Default[0] );
		    Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_MCLK_OUT_DSP_ADAU1452_ADDR,    2, &R12_MCLK_OUT_DSP_ADAU1452_Default[0] );
		    Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_PLL_ENABLE_DSP_ADAU1452_ADDR,  2, &R13_PLL_ENABLE_DSP_ADAU1452_Default[0] );
		    regStatus = 0;
		    Delay(20, FreeRTOS);
		}
		else{
			Receiver_DSP( REG_PLL_CTRL0_DSP_ADAU1452_ADDR,    &result[0], 2, 500);  if( result[0] != 0 || result[1] != 96) { regStatus = 1; }
			Receiver_DSP( REG_PLL_CTRL1_DSP_ADAU1452_ADDR,    &result[0], 2, 500);  if( result[0] != 0 || result[1] != 3 ) { regStatus = 1; }
			Receiver_DSP( REG_PLL_CLK_SRC_DSP_ADAU1452_ADDR,  &result[0], 2, 500);  if( result[0] != 0 || result[1] != 1 ) { regStatus = 1; }
			Receiver_DSP( REG_MCLK_OUT_DSP_ADAU1452_ADDR,     &result[0], 2, 500);  if( result[0] != 0 || result[1] != 7 ) { regStatus = 1; }
			Receiver_DSP( REG_PLL_ENABLE_DSP_ADAU1452_ADDR,   &result[0], 2, 500);  if( result[0] != 0 || result[1] != 1 ) { regStatus = 1; }

			if(regStatus==0){
				StatusPll = 40;
				Init_DSP_ADAU1452();
				//Init_DSP_ADAU1701();
				DSP_Struct_Chip_Init();
			}
		}
    }
}


void Init_DSP_ADAU1452(void){

	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_POWER_ENABLE0_DSP_ADAU1452_ADDR, REG_POWER_ENABLE0_DSP_ADAU1452_BYTE, &R15_POWER_ENABLE0_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_POWER_ENABLE1_DSP_ADAU1452_ADDR, REG_POWER_ENABLE1_DSP_ADAU1452_BYTE, &R16_POWER_ENABLE1_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_PANIC_CLEAR_DSP_ADAU1452_ADDR, REG_PANIC_CLEAR_DSP_ADAU1452_BYTE, &R17_PANIC_CLEAR_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_PANIC_PARITY_MASK_DSP_ADAU1452_ADDR, REG_PANIC_PARITY_MASK_DSP_ADAU1452_BYTE, &R18_PANIC_PARITY_MASK_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_MP0_MODE_DSP_ADAU1452_ADDR, REG_MP0_MODE_DSP_ADAU1452_BYTE, &R19_MP0_MODE_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SDATA_OUT0_PIN_DSP_ADAU1452_ADDR, REG_SDATA_OUT0_PIN_DSP_ADAU1452_BYTE, &R20_SDATA_OUT0_PIN_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SDATA_OUT1_PIN_DSP_ADAU1452_ADDR, REG_SDATA_OUT1_PIN_DSP_ADAU1452_BYTE, &R21_SDATA_OUT1_PIN_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SDATA_OUT2_PIN_DSP_ADAU1452_ADDR, REG_SDATA_OUT2_PIN_DSP_ADAU1452_BYTE, &R22_SDATA_OUT2_PIN_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SDATA_OUT3_PIN_DSP_ADAU1452_ADDR, REG_SDATA_OUT3_PIN_DSP_ADAU1452_BYTE, &R23_SDATA_OUT3_PIN_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SPDIF_TX_PIN_DSP_ADAU1452_ADDR, REG_SPDIF_TX_PIN_DSP_ADAU1452_BYTE, &R24_SPDIF_TX_PIN_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SCLK_SCL_M_PIN_DSP_ADAU1452_ADDR, REG_SCLK_SCL_M_PIN_DSP_ADAU1452_BYTE, &R25_SCLK_SCL_M_PIN_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_MISO_SDA_M_PIN_DSP_ADAU1452_ADDR, REG_MISO_SDA_M_PIN_DSP_ADAU1452_BYTE, &R26_MISO_SDA_M_PIN_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SS_M_PIN_DSP_ADAU1452_ADDR, REG_SS_M_PIN_DSP_ADAU1452_BYTE, &R27_SS_M_PIN_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_MOSI_M_PIN_DSP_ADAU1452_ADDR, REG_MOSI_M_PIN_DSP_ADAU1452_BYTE, &R28_MOSI_M_PIN_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_INPUT0_DSP_ADAU1452_ADDR, REG_ASRC_INPUT0_DSP_ADAU1452_BYTE, &R29_ASRC_INPUT0_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_INPUT1_DSP_ADAU1452_ADDR, REG_ASRC_INPUT1_DSP_ADAU1452_BYTE, &R30_ASRC_INPUT1_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_INPUT2_DSP_ADAU1452_ADDR, REG_ASRC_INPUT2_DSP_ADAU1452_BYTE, &R31_ASRC_INPUT2_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_INPUT3_DSP_ADAU1452_ADDR, REG_ASRC_INPUT3_DSP_ADAU1452_BYTE, &R32_ASRC_INPUT3_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_INPUT4_DSP_ADAU1452_ADDR, REG_ASRC_INPUT4_DSP_ADAU1452_BYTE, &R33_ASRC_INPUT4_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_INPUT5_DSP_ADAU1452_ADDR, REG_ASRC_INPUT5_DSP_ADAU1452_BYTE, &R34_ASRC_INPUT5_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_INPUT6_DSP_ADAU1452_ADDR, REG_ASRC_INPUT6_DSP_ADAU1452_BYTE, &R35_ASRC_INPUT6_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_INPUT7_DSP_ADAU1452_ADDR, REG_ASRC_INPUT7_DSP_ADAU1452_BYTE, &R36_ASRC_INPUT7_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_OUT_RATE0_DSP_ADAU1452_ADDR, REG_ASRC_OUT_RATE0_DSP_ADAU1452_BYTE, &R37_ASRC_OUT_RATE0_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_OUT_RATE1_DSP_ADAU1452_ADDR, REG_ASRC_OUT_RATE1_DSP_ADAU1452_BYTE, &R38_ASRC_OUT_RATE1_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_OUT_RATE2_DSP_ADAU1452_ADDR, REG_ASRC_OUT_RATE2_DSP_ADAU1452_BYTE, &R39_ASRC_OUT_RATE2_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_OUT_RATE3_DSP_ADAU1452_ADDR, REG_ASRC_OUT_RATE3_DSP_ADAU1452_BYTE, &R40_ASRC_OUT_RATE3_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_OUT_RATE4_DSP_ADAU1452_ADDR, REG_ASRC_OUT_RATE4_DSP_ADAU1452_BYTE, &R41_ASRC_OUT_RATE4_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_OUT_RATE6_DSP_ADAU1452_ADDR, REG_ASRC_OUT_RATE6_DSP_ADAU1452_BYTE, &R42_ASRC_OUT_RATE6_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_ASRC_OUT_RATE7_DSP_ADAU1452_ADDR, REG_ASRC_OUT_RATE7_DSP_ADAU1452_BYTE, &R43_ASRC_OUT_RATE7_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE0_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE0_DSP_ADAU1452_BYTE, &R44_SOUT_SOURCE0_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE1_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE1_DSP_ADAU1452_BYTE, &R45_SOUT_SOURCE1_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE2_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE2_DSP_ADAU1452_BYTE, &R46_SOUT_SOURCE2_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE3_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE3_DSP_ADAU1452_BYTE, &R47_SOUT_SOURCE3_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE4_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE4_DSP_ADAU1452_BYTE, &R48_SOUT_SOURCE4_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE5_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE5_DSP_ADAU1452_BYTE, &R49_SOUT_SOURCE5_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE6_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE6_DSP_ADAU1452_BYTE, &R50_SOUT_SOURCE6_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE7_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE7_DSP_ADAU1452_BYTE, &R51_SOUT_SOURCE7_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE8_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE8_DSP_ADAU1452_BYTE, &R52_SOUT_SOURCE8_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE9_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE9_DSP_ADAU1452_BYTE, &R53_SOUT_SOURCE9_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE10_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE10_DSP_ADAU1452_BYTE, &R54_SOUT_SOURCE10_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE11_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE11_DSP_ADAU1452_BYTE, &R55_SOUT_SOURCE11_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE12_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE12_DSP_ADAU1452_BYTE, &R56_SOUT_SOURCE12_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE13_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE13_DSP_ADAU1452_BYTE, &R57_SOUT_SOURCE13_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE14_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE14_DSP_ADAU1452_BYTE, &R58_SOUT_SOURCE14_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE15_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE15_DSP_ADAU1452_BYTE, &R59_SOUT_SOURCE15_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE16_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE16_DSP_ADAU1452_BYTE, &R60_SOUT_SOURCE16_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE17_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE17_DSP_ADAU1452_BYTE, &R61_SOUT_SOURCE17_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE18_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE18_DSP_ADAU1452_BYTE, &R62_SOUT_SOURCE18_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE19_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE19_DSP_ADAU1452_BYTE, &R63_SOUT_SOURCE19_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE20_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE20_DSP_ADAU1452_BYTE, &R64_SOUT_SOURCE20_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE21_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE21_DSP_ADAU1452_BYTE, &R65_SOUT_SOURCE21_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE22_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE22_DSP_ADAU1452_BYTE, &R66_SOUT_SOURCE22_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SOUT_SOURCE23_DSP_ADAU1452_ADDR, REG_SOUT_SOURCE23_DSP_ADAU1452_BYTE, &R67_SOUT_SOURCE23_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SPDIFTX_INPUT_DSP_ADAU1452_ADDR, REG_SPDIFTX_INPUT_DSP_ADAU1452_BYTE, &R68_SPDIFTX_INPUT_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SERIAL_BYTE_0_0_DSP_ADAU1452_ADDR, REG_SERIAL_BYTE_0_0_DSP_ADAU1452_BYTE, &R69_SERIAL_BYTE_0_0_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SERIAL_BYTE_1_0_DSP_ADAU1452_ADDR, REG_SERIAL_BYTE_1_0_DSP_ADAU1452_BYTE, &R70_SERIAL_BYTE_1_0_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SERIAL_BYTE_2_0_DSP_ADAU1452_ADDR, REG_SERIAL_BYTE_2_0_DSP_ADAU1452_BYTE, &R71_SERIAL_BYTE_2_0_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SERIAL_BYTE_3_0_DSP_ADAU1452_ADDR, REG_SERIAL_BYTE_3_0_DSP_ADAU1452_BYTE, &R72_SERIAL_BYTE_3_0_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SERIAL_BYTE_3_1_DSP_ADAU1452_ADDR, REG_SERIAL_BYTE_3_1_DSP_ADAU1452_BYTE, &R73_SERIAL_BYTE_3_1_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SERIAL_BYTE_4_0_DSP_ADAU1452_ADDR, REG_SERIAL_BYTE_4_0_DSP_ADAU1452_BYTE, &R74_SERIAL_BYTE_4_0_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SERIAL_BYTE_4_1_DSP_ADAU1452_ADDR, REG_SERIAL_BYTE_4_1_DSP_ADAU1452_BYTE, &R75_SERIAL_BYTE_4_1_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SERIAL_BYTE_5_0_DSP_ADAU1452_ADDR, REG_SERIAL_BYTE_5_0_DSP_ADAU1452_BYTE, &R76_SERIAL_BYTE_5_0_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SERIAL_BYTE_5_1_DSP_ADAU1452_ADDR, REG_SERIAL_BYTE_5_1_DSP_ADAU1452_BYTE, &R77_SERIAL_BYTE_5_1_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SERIAL_BYTE_6_0_DSP_ADAU1452_ADDR, REG_SERIAL_BYTE_6_0_DSP_ADAU1452_BYTE, &R78_SERIAL_BYTE_6_0_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SERIAL_BYTE_6_1_DSP_ADAU1452_ADDR, REG_SERIAL_BYTE_6_1_DSP_ADAU1452_BYTE, &R79_SERIAL_BYTE_6_1_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SERIAL_BYTE_7_0_DSP_ADAU1452_ADDR, REG_SERIAL_BYTE_7_0_DSP_ADAU1452_BYTE, &R80_SERIAL_BYTE_7_0_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SERIAL_BYTE_7_1_DSP_ADAU1452_ADDR, REG_SERIAL_BYTE_7_1_DSP_ADAU1452_BYTE, &R81_SERIAL_BYTE_7_1_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SPDIF_RESTART_DSP_ADAU1452_ADDR, REG_SPDIF_RESTART_DSP_ADAU1452_BYTE, &R82_SPDIF_RESTART_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_SPDIF_TX_EN_DSP_ADAU1452_ADDR, REG_SPDIF_TX_EN_DSP_ADAU1452_BYTE, &R83_SPDIF_TX_EN_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, PROGRAM_ADDR_DSP_ADAU1452, PROGRAM_SIZE_DSP_ADAU1452, &Program_Data_DSP_ADAU1452[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, PARAM_ADDR_DSP_ADAU1452, PARAM_SIZE_DSP_ADAU1452, &Param_Data_DSP_ADAU1452[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, DM1_DATA_ADDR_DSP_ADAU1452, DM1_DATA_SIZE_DSP_ADAU1452, &DM1_DATA_Data_DSP_ADAU1452[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_KILL_CORE_DSP_ADAU1452_ADDR, REG_KILL_CORE_DSP_ADAU1452_BYTE, &R87_KILL_CORE_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_START_ADDRESS_DSP_ADAU1452_ADDR, REG_START_ADDRESS_DSP_ADAU1452_BYTE, &R88_START_ADDRESS_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_START_PULSE_DSP_ADAU1452_ADDR, REG_START_PULSE_DSP_ADAU1452_BYTE, &R89_START_PULSE_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_START_CORE_DSP_ADAU1452_ADDR, REG_START_CORE_DSP_ADAU1452_BYTE, &R90_START_CORE_DSP_ADAU1452_Default[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_START_CORE_DSP_ADAU1452_ADDR, REG_START_CORE_DSP_ADAU1452_BYTE, &R91_START_CORE_DSP_ADAU1452_Default[0] );
	Delay(60, FreeRTOS);
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_HIBERNATE_DSP_ADAU1452_ADDR, REG_HIBERNATE_DSP_ADAU1452_BYTE, &R93_HIBERNATE_DSP_ADAU1452_Default[0] );
	InitDspSerialInput();
	DSP_Clock();
}


void Init_DSP_ADAU1701(){
	if (DevState_I2C1(DEVICE_ADDR_RADIO_ADAU1701<<1, 1, 100)     == WR_OK) {
		Dixom.Module.MiniDSP.availability = YES;
		Transmit_Sigma1701( DEVICE_ADDR_IC_1<<1, REG_COREREGISTER_IC_1_ADDR, REG_COREREGISTER_IC_1_BYTE, &R0_COREREGISTER_IC_1_Default[0] );
		Delay(20, FreeRTOS);
		Transmit_Sigma1701( DEVICE_ADDR_IC_1<<1, PROGRAM_ADDR_IC_1, PROGRAM_SIZE_IC_1, &Program_Data_IC_1[0] );
		Transmit_Sigma1701( DEVICE_ADDR_IC_1<<1, PARAM_ADDR_IC_1, PARAM_SIZE_IC_1, &Param_Data_IC_1[0] );
		Delay(20, FreeRTOS);
		Transmit_Sigma1701( DEVICE_ADDR_IC_1<<1, REG_COREREGISTER_IC_1_ADDR , R3_HWCONFIGURATION_IC_1_SIZE, &R3_HWCONFIGURATION_IC_1_Default[0] );
		Delay(20, FreeRTOS);
		Transmit_Sigma1701( DEVICE_ADDR_IC_1<<1, REG_COREREGISTER_IC_1_ADDR, REG_COREREGISTER_IC_1_BYTE, &R4_COREREGISTER_IC_1_Default[0] );
	}else{
		Dixom.Module.MiniDSP.availability = NO;
	}
}


#define Resemp1_ADDR    0xF100
ADI_REG_TYPE Resemp1OFF[2] = { 0x00,0x82};
ADI_REG_TYPE Resemp1ON [2] = { 0x00,0x81};

#define Resemp2_ADDR    0xF101
ADI_REG_TYPE Resemp2OFF[2] = { 0x00,0x02};
ADI_REG_TYPE Resemp2ON [2] = { 0x00,0x01};

#define Resemp3_ADDR    0xF102
ADI_REG_TYPE Resemp3OFF[2] = { 0x00,0xA2};
ADI_REG_TYPE Resemp3ON [2] = { 0x00,0xA1};

#define Resemp4_ADDR    0xF103
ADI_REG_TYPE Resemp4OFF[2] = { 0x00,0x42};
ADI_REG_TYPE Resemp4ON [2] = { 0x00,0x41};

#define Resemp5_ADDR    0xF104
ADI_REG_TYPE Resemp5OFF[2] = { 0x00,0x0A};
ADI_REG_TYPE Resemp5ON [2] = { 0x00,0x0B};

#define Resemp6_ADDR    0xF105
ADI_REG_TYPE Resemp6OFF[2] = { 0x00,0x02};
ADI_REG_TYPE Resemp6ON [2] = { 0x00,0x04};

#define Resemp7_ADDR    0xF106
ADI_REG_TYPE Resemp7OFF[2] = { 0x00,0x02};
ADI_REG_TYPE Resemp7ON [2] = { 0x00,0x05};

#define Resemp8_ADDR    0xF000
ADI_REG_TYPE Resemp8ON [2] = { 0x00,0x60};

#define Resemp9_ADDR    0xF003
ADI_REG_TYPE Resemp9OFF[2] = { 0x00,0x00};
ADI_REG_TYPE Resemp9ON [2] = { 0x00,0x01};







void InitDspSerialInput(void){

	 Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, Resemp1_ADDR, 2, & Resemp1OFF[0]);
	 Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, Resemp2_ADDR, 2, & Resemp2OFF[0]);
	 Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, Resemp3_ADDR, 2, & Resemp3OFF[0]);
	 Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, Resemp4_ADDR, 2, & Resemp4OFF[0]);
	 Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, Resemp5_ADDR, 2, & Resemp5OFF[0]);
	 Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, Resemp6_ADDR, 2, & Resemp6OFF[0]);
	 Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, Resemp7_ADDR, 2, & Resemp7OFF[0]);
	 Delay(200, FreeRTOS);
	 Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, Resemp1_ADDR, 2, & Resemp1ON[0]);
	 Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, Resemp2_ADDR, 2, & Resemp2ON[0]);
	 Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, Resemp3_ADDR, 2, & Resemp3ON[0]);
	 Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, Resemp4_ADDR, 2, & Resemp4ON[0]);
	 Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, Resemp5_ADDR, 2, & Resemp5ON[0]);
	 Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, Resemp6_ADDR, 2, & Resemp6ON[0]);
	 Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, Resemp7_ADDR, 2, & Resemp7ON[0]);
}



ADI_REG_TYPE On_22_579[2] = {
0x00, 0x01
};

ADI_REG_TYPE Off_22_579[2] = {
0x00, 0x00
};

ADI_REG_TYPE REG_MP0_MODE[2] = {
0x00, 0x05
};


void DSP_Clock(){
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_MP0_MODE_DSP_ADAU1452_ADDR, 2, &REG_MP0_MODE[0] );
	Transmit_Sigma( DEVICE_ADDR_DSP_ADAU1452, REG_MP0_WRITE_DSP_ADAU1452_ADDR, 2, &Off_22_579[0] );
}

void SOUND_REINIT(void){
//	StructsSoundInit();
}
uint32_t LD_Data32[50];
uint16_t LD_Data16[50];
uint16_t LD_Data8[50];

uint8_t sendDelay = 0;
uint8_t updateDelay = 0;

uint8_t ClipState = 0;
uint8_t ClipDetectDelay = 0;
uint8_t ClipDetectSendDelay = 0;

uint8_t LD_DataSend[64];
uint8_t SI_DataSend[64];

uint8_t Change_LD = 0;


uint8_t LD_DSP_Read[200];


void updateLevel(){

	if(Dixom.DevInfo.InMode == ReadyForWork){
		updateDelay++;

		if(updateDelay > 5){
			updateDelay = 0;

			Receiver_DSP( ADDR_DT_AUXR_2,(uint8_t *)&LD_Data16[0], 2, 500);

			Receiver_DSP( ADDR_DT_USBL,       (uint8_t *)&LD_Data16[1], 2, 500);
			Receiver_DSP( ADDR_DT_USBR,       (uint8_t *)&LD_Data16[2], 2, 500);

			Receiver_DSP( ADDR_DT_BLUETOOTHL,     (uint8_t *)&LD_Data16[3], 2, 500);
			Receiver_DSP( ADDR_DT_BLUETOOTHR,     (uint8_t *)&LD_Data16[4], 2, 500);

			Receiver_DSP( ADDR_DT_AUXL,       (uint8_t *)&LD_Data16[5], 2, 500);
			Receiver_DSP( ADDR_DT_AUXR,       (uint8_t *)&LD_Data16[6], 2, 500);

			Receiver_DSP( ADDR_DT_RADIOL,     (uint8_t *)&LD_Data16[7], 2, 500);
			Receiver_DSP( ADDR_DT_RADIOR,     (uint8_t *)&LD_Data16[8], 2, 500);

			Receiver_DSP( ADDR_DT_SPDIFL,     (uint8_t *)&LD_Data16[9], 2, 500);
			Receiver_DSP( ADDR_DT_SPDIFR,    (uint8_t *)&LD_Data16[10], 2, 500);

			Receiver_DSP( ADDR_DT_MICL,      (uint8_t *)&LD_Data16[11], 2, 500);
			Receiver_DSP( ADDR_DT_MICR,      (uint8_t *)&LD_Data16[12], 2, 500);



			for(uint8_t i = 0; i < 33; i++){

				if(i==0){

					if (LD_Data16[i]>60000) {
						LD_Data16[i] = 60000;
					}
					LD_DataSend[i+7] = LD_Data16[i] * 255 / 60000;
					Dixom.Module.DSP.LvlDetec[0].data = LD_DataSend[i+7];
					//RefreshDisplay();

				}else if(i<13){
					if (LD_Data16[i]>30000){
						LD_Data16[i] = 30000;
					}
					LD_DataSend[i+7] = LD_Data16[i] * 255 / 30000;

				}else{
					LD_DataSend[i+7] = LD_Data32[i-13] * 255 / 30000;
				}
			}
		}
	}
}

uint8_t ddsds[30];


uint16_t sendDelaySI = 0;
uint8_t micState = 1;

uint8_t ALtime = 0;

uint8_t ReconfigurationState = 0;

uint8_t AuxVolState[30];
uint8_t DelayState[20];
uint8_t OldVolMic;

uint8_t OldServiceInfo[10];

void LoopLevelDetector(){

	//if(GetSettings (SettingsMicCancelEcho) == ON){

	if(Dixom.DevInfo.InMode == ReadyForWork){


			LD_DataSend[0] = '4'; //Level
			LD_DataSend[1] = ' '; //Detector
			LD_DataSend[2] = '0';
			LD_DataSend[3] = ' ';
			LD_DataSend[4] = '0';
			LD_DataSend[5] = ' ';
			LD_DataSend[6] = ' ';


			sendDelay++;

			if(sendDelay > 30 &&(Change_LD != LD_DataSend[7])){

				Change_LD = LD_DataSend[7];
				sendDelay = 0;
				if(Dixom.Module.DSP.Settings[LEVEL_DETECTOR].Data == ON){
 		 	   	 	TransmitDataOutputs(&LD_DataSend[0], 20,  true,  false, allAvailable);


				}
			}
			updateLevel();




		if(sendDelaySI > 1000 && (
				  (SI_DataSend[3] != Dixom.Service.ACC.Voltage
				  &&SI_DataSend[3] !=Dixom.Service.ACC.Voltage+1
				  &&SI_DataSend[3] !=Dixom.Service.ACC.Voltage-1)
				  ||SI_DataSend[4] !=Dixom.Service.PeripheryState[Remout])){

			sendDelaySI = 0;


		}else if(Dixom.DevInfo.InMode == ReadyForWork){
			sendDelaySI++;
		}
	}


	ClipDetectDelay++;

	if(ClipDetectDelay > 100 && Dixom.DevInfo.InMode == ReadyForWork){

		ClipDetectDelay = 0;

		if(Dixom.Module.DSP.Settings[LEVEL_DETECTOR].Data == OFF){
			Receiver_DSP( ADDR_DT_AUXR_2,(uint8_t *)&LD_Data16[0], 2, 500);

			if (LD_Data16[0]>60000){
				LD_Data16[0] = 60000;
			}
			LD_DataSend[7] = LD_Data16[0] * 255 / 60000;
			Dixom.Module.DSP.LvlDetec[0].data = LD_DataSend[7];
		}

		if(ClipDetectSendDelay > 10 && Dixom.Module.DSP.LvlDetec[0].data == 255){

			ClipDetectSendDelay = 0;
			ClipState = 1;
		//	Transmit_Data_Out((uint8_t *)"Attention the sound in the clip!!!", 34, 0, FreeRTOS, NO);


		}else if(ClipDetectSendDelay > 10 &&  Dixom.Module.DSP.LvlDetec[0].data < 255){

			ClipDetectSendDelay = 0;

			if(ClipState == 1){
				ClipState = 0;
		//		Transmit_Data_Out((uint8_t *)"The sound came out of the clip", 31, 0, FreeRTOS, NO);
			}


		}else if(Dixom.Module.DSP.LvlDetec[0].data == 255){
			ClipDetectSendDelay++;
		}

	}

}


void GetServiceInformation(){
/*	SI_DataSend[0] = 'S'; //Service
	SI_DataSend[1] = 'I'; //Info
	SI_DataSend[2] = ' ';
	SI_DataSend[3] = Dixom.Service.ACC.Voltage;
	SI_DataSend[4] = Dixom.Service.PeripheryState[Remout];
	Transmit_Data_Out(&SI_DataSend[0], 5, 0, FreeRTOS, NO);*/
}








